
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Mozilla Telemetry ingestion on Google Cloud Platform">
      
      
      
        <meta name="author" content="Mozilla Data Platform Team">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.2.5">
    
    
      
        <title>Overview - GCP Ingestion</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.be71726b.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.3f5d1f46.min.css">
        
          
          
          <meta name="theme-color" content="#009485">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="teal" data-md-color-accent="">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ingestion-sink" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="GCP Ingestion" class="md-header__button md-logo" aria-label="GCP Ingestion" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            GCP Ingestion
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Overview
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/mozilla/gcp-ingestion/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href=".." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../architecture/overview/" class="md-tabs__link">
        Architecture
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../ingestion-edge/" class="md-tabs__link">
        ingestion-edge
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../ingestion-beam/" class="md-tabs__link">
        ingestion-beam
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="./" class="md-tabs__link md-tabs__link--active">
        ingestion-sink
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="GCP Ingestion" class="md-nav__button md-logo" aria-label="GCP Ingestion" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    GCP Ingestion
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/mozilla/gcp-ingestion/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" data-md-state="indeterminate" type="checkbox" id="__nav_2" checked>
      
      <label class="md-nav__link" for="__nav_2">
        Architecture
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Architecture" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Architecture
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" data-md-state="indeterminate" type="checkbox" id="__nav_2_2" checked>
      
      <label class="md-nav__link" for="__nav_2_2">
        Architecture
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Architecture" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Architecture
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/bigquery_sink_specification/" class="md-nav__link">
        Live Sink Service Specification
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/decoder_service_specification/" class="md-nav__link">
        Decoder Service Specification
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/differences_from_aws/" class="md-nav__link">
        Differences from AWS
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/edge_migration_plan/" class="md-nav__link">
        Plans for migrating edge traffic to GCP Ingestion
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/edge_service_specification/" class="md-nav__link">
        Edge Service Specification
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/landfill_service_specification/" class="md-nav__link">
        Raw Sink Service Specification
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/pain_points/" class="md-nav__link">
        Pain points
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/reliability/" class="md-nav__link">
        Reliability
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/test_requirements/" class="md-nav__link">
        Test Requirements
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" data-md-state="indeterminate" type="checkbox" id="__nav_3" checked>
      
      <label class="md-nav__link" for="__nav_3">
        ingestion-edge
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="ingestion-edge" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          ingestion-edge
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ingestion-edge/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" data-md-state="indeterminate" type="checkbox" id="__nav_4" checked>
      
      <label class="md-nav__link" for="__nav_4">
        ingestion-beam
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="ingestion-beam" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          ingestion-beam
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ingestion-beam/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" data-md-state="indeterminate" type="checkbox" id="__nav_4_2" checked>
      
      <label class="md-nav__link" for="__nav_4_2">
        Ingestion beam
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Ingestion beam" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Ingestion beam
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ingestion-beam/contextual-services-job/" class="md-nav__link">
        Contextual Services Reporter Job
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ingestion-beam/decoder-job/" class="md-nav__link">
        Decoder Job
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ingestion-beam/ingestion_testing_workflow/" class="md-nav__link">
        Ingestion Testing Workflow
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ingestion-beam/rally-job/" class="md-nav__link">
        Rally Decoder Job
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ingestion-beam/republisher-job/" class="md-nav__link">
        Republisher Job
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ingestion-beam/sink-job/" class="md-nav__link">
        Sink Job
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      <label class="md-nav__link" for="__nav_5">
        ingestion-sink
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="ingestion-sink" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          ingestion-sink
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Overview
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Overview
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#supported-input-and-outputs" class="md-nav__link">
    Supported Input and Outputs
  </a>
  
    <nav class="md-nav" aria-label="Supported Input and Outputs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-input-and-output" class="md-nav__link">
    Test Input and Output
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    Configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#output-specification" class="md-nav__link">
    Output Specification
  </a>
  
    <nav class="md-nav" aria-label="Output Specification">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bigquery" class="md-nav__link">
    BigQuery
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attribute-placeholders" class="md-nav__link">
    Attribute placeholders
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#encoding" class="md-nav__link">
    Encoding
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#google-cloud-storage-file-prefix" class="md-nav__link">
    Google Cloud Storage file prefix
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#executing" class="md-nav__link">
    Executing
  </a>
  
    <nav class="md-nav" aria-label="Executing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#locally-with-docker" class="md-nav__link">
    Locally with Docker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#locally-without-docker" class="md-nav__link">
    Locally without Docker
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#supported-input-and-outputs" class="md-nav__link">
    Supported Input and Outputs
  </a>
  
    <nav class="md-nav" aria-label="Supported Input and Outputs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-input-and-output" class="md-nav__link">
    Test Input and Output
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    Configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#output-specification" class="md-nav__link">
    Output Specification
  </a>
  
    <nav class="md-nav" aria-label="Output Specification">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bigquery" class="md-nav__link">
    BigQuery
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attribute-placeholders" class="md-nav__link">
    Attribute placeholders
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#encoding" class="md-nav__link">
    Encoding
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#google-cloud-storage-file-prefix" class="md-nav__link">
    Google Cloud Storage file prefix
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#executing" class="md-nav__link">
    Executing
  </a>
  
    <nav class="md-nav" aria-label="Executing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#locally-with-docker" class="md-nav__link">
    Locally with Docker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#locally-without-docker" class="md-nav__link">
    Locally without Docker
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/mozilla/gcp-ingestion/edit/master/docs/ingestion-sink/index.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="ingestion-sink">Ingestion Sink</h1>
<p>A Java application that runs in Kubernetes, reading input from Google Cloud
Pub/Sub and emitting records to batch-oriented outputs like GCS or BigQuery.
Defined in the <code>ingestion-sink</code> package
(<a href="https://github.com/mozilla/gcp-ingestion/tree/main/ingestion-sink/">source</a>).</p>
<h2 id="supported-input-and-outputs">Supported Input and Outputs</h2>
<p>Supported inputs:</p>
<ul>
<li>Google Cloud PubSub</li>
</ul>
<p>Supported outputs:</p>
<ul>
<li>Google Cloud PubSub</li>
<li>Google Cloud Storage</li>
<li>Google Cloud BigQuery</li>
</ul>
<h3 id="test-input-and-output">Test Input and Output</h3>
<p>Test inputs will stop when an exception is raised or the end of the pipe or
file is reached. Supported test inputs:</p>
<ul>
<li><code>System.in</code> (stdin), by setting <code>INPUT_PIPE</code> to any of <code>-</code>, <code>0</code>, <code>in</code>,
  <code>stdin</code>, <code>/dev/stdin</code></li>
<li>A single file, by setting <code>INPUT_PIPE</code> to <code>/path/to/input_file</code></li>
</ul>
<p>Test outputs don't exercise batching and will write messages as newline
delimited JSON in the order they are received. Supported test outputs:</p>
<ul>
<li><code>System.out</code> (stdout), by setting <code>OUTPUT_PIPE</code> to any of <code>-</code>, <code>1</code>, <code>out</code>,
  <code>stdout</code>, <code>/dev/stdout</code></li>
<li><code>System.err</code> (stderr), by setting <code>OUTPUT_PIPE</code> to any of <code>2</code>, <code>err</code>,
  <code>stderr</code>, <code>/dev/stderr</code></li>
<li>A single file, by setting <code>OUTPUT_PIPE</code> to <code>/path/to/output_file</code></li>
</ul>
<h2 id="configuration">Configuration</h2>
<p>All configuration is controlled by environment variables.</p>
<h2 id="output-specification">Output Specification</h2>
<p>Depending on the environment variables provided, the application will
automatically determine where to deliver messages.</p>
<p>If <code>OUTPUT_BUCKET</code> is specified without <code>BIG_QUERY_OUTPUT_MODE</code>, then messages
will be delivered to Google Cloud Storage.</p>
<p>If <code>OUTPUT_TOPIC</code> is specified without <code>OUTPUT_BUCKET</code> or
<code>BIG_QUERY_OUTPUT_MODE</code>, then messages will be delivered to Google Cloud
Pub/Sub.</p>
<p>If <code>OUTPUT_TABLE</code> is specified without <code>BIG_QUERY_OUTPUT_MODE</code> or with
<code>BIG_QUERY_OUTPUT_MODE=streaming</code>, then messages will be delivered to BigQuery
via the streaming API.</p>
<p>If <code>OUTPUT_TABLE</code> is specified with <code>BIG_QUERY_OUTPUT_MODE=file_loads</code>, then
messages will be delivered to Google Cloud Storage based on <code>OUTPUT_BUCKET</code> and
for each blob a notification will be delivered to Google Cloud Pub/Sub based on
<code>OUTPUT_TOPIC</code>. Separate instances of ingestion-sink must consume notifications
from Google Cloud Pub/Sub and deliver messages to BigQuery via load jobs.</p>
<p>If <code>OUTPUT_TABLE</code> is specified with <code>BIG_QUERY_OUTPUT_MODE=mixed</code>, then
messages will be delivered to BigQuery via both the streaming API and load
jobs, and <code>OUTPUT_BUCKET</code> is required. If <code>OUTPUT_TOPIC</code> is specified then it
will be used the same as with <code>BIG_QUERY_OUTPUT_MODE=file_loads</code>, otherwise
load jobs will be submitted by each running instance of ingestion-sink.</p>
<p>If none of the above configuration options are provided, then messages must be
notifications from <code>BIG_QUERY_OUTPUT_MODE=file_loads</code> or
<code>BIG_QUERY_OUTPUT_MODE=mixed</code>, and the blobs they indicate will be submitted to
BigQuery via load jobs.</p>
<h3 id="bigquery">BigQuery</h3>
<p><code>OUTPUT_TABLE</code> must be a <code>tableSpec</code> of form <code>dataset.tablename</code>
or the more verbose <code>projectId.dataset.tablename</code>. The values can contain
attribute placeholders of form <code>${attribute_name}</code>. To set dataset to the
document namespace and table name to the document type, specify:</p>
<pre><code>OUTPUT_TABLE='${document_namespace}.${document_type}'
</code></pre>
<p>All <code>-</code> characters in the attributes will be converted to <code>_</code> per BigQuery
naming restrictions. Additionally, document namespace and type values will
be processed to ensure they are in snake case format (<code>untrustedModules</code>
becomes <code>untrusted_modules</code>).</p>
<p>Defaults for the placeholders using <code>${attribute_name:-default_value}</code>
are supported, but likely don't make much sense since it's unlikely that
there is a default table whose schema is compatible with all potential
payloads.</p>
<h3 id="attribute-placeholders">Attribute placeholders</h3>
<p>We support routing individual messages to different output locations based on
the <code>PubsubMessage</code> attribute map. Routing is accomplished by adding
placeholders of form <code>${attribute_name:-default_value}</code> to the path.</p>
<p>For example, to route based on a <code>document_type</code> attribute, your path might
look like:</p>
<pre><code>OUTPUT_BUCKET=gs://mybucket/mydocs/${document_type:-UNSPECIFIED}/myfileprefix
</code></pre>
<p>Messages with <code>document_type</code> of "main" would be grouped together and end up in
the following directory:</p>
<pre><code>gs://mybucket/mydocs/main/
</code></pre>
<p>Messages with <code>document_type</code> set to <code>null</code> or missing that attribute
completely would be grouped together and end up in directory:</p>
<pre><code>gs://mybucket/mydocs/UNSPECIFIED/
</code></pre>
<p>Note that placeholders <em>must</em> specify a default value so that a poorly
formatted message doesn't cause a pipeline exception. A placeholder without a
default will result in an <code>IllegalArgumentException</code> on pipeline startup.</p>
<p>File-based outputs support the additional <em>derived</em> attributes
<code>"submission_date"</code> and <code>"submission_hour"</code> which will be parsed from the value
of the <code>submission_timestamp</code> attribute if it exists. These can be useful for
making sure your output specification buckets messages into hourly directories.</p>
<p>The templating and default syntax used here is based on the
<a href="https://commons.apache.org/proper/commons-text/javadocs/api-release/org/apache/commons/text/StringSubstitutor.html">Apache commons-text <code>StringSubstitutor</code></a>,
which in turn bases its syntax on common practice in bash and other Unix/Linux
shells. Beware the need for proper escaping on the command line (use <code>\$</code> in
place of <code>$</code>), as your shell may try to substitute in values for your
placeholders before they're passed to <code>Sink</code>.</p>
<p><a href="https://cloud.google.com/pubsub/docs/reference/rest/v1/PubsubMessage">Google's PubsubMessage format</a>
allows arbitrary strings for attribute names and values. We place the following restrictions
on attribute names and default values used in placeholders:</p>
<ul>
<li>attribute names may not contain the string <code>:-</code></li>
<li>attribute names may not contain curly braces (<code>{</code> or <code>}</code>)</li>
<li>default values may not contain curly braces (<code>{</code> or <code>}</code>)</li>
</ul>
<h3 id="encoding">Encoding</h3>
<p>When writing messages to Google Cloud Storage or BigQuery, the message received
from Google Cloud Pub/Sub will be encoded as a JSON object.</p>
<p>When <code>OUTPUT_FORMAT</code> is unspecified or <code>raw</code>, messages will have bytes encoded as
a <code>"payload"</code> field with base64 encoding, and each attribute encoded as field.
This is the format used for <code>payload_bytes_raw.*</code> tables.</p>
<p>When <code>OUTPUT_FORMAT</code> is <code>decoded</code> messages will have bytes encoded as with
<code>OUTPUT_FORMAT=raw</code>, but attributes will be encoded using the nested metadata
format of decoded pings. This is the format used for <code>payload_bytes_decoded.*</code>
tables.</p>
<p>When <code>OUTPUT_FORMAT</code> is <code>payload</code> messages will have bytes decoded as JSON, and
will be transformed to coerce types and use snake case for compatibility with BigQuery.
This is the format used for <code>*_live.*</code> tables. This requires specifying a local
path to a gzipped tar archive that contains BigQuery table schemas as
<code>SCHEMAS_LOCATION</code>. If messages bytes are compressed then
<code>INPUT_COMPRESSION=gzip</code> must also be specified to ensure they are decompressed
before they are decoded as JSON.</p>
<p>When <code>OUTPUT_FORMAT</code> is <code>beam</code> messages will have bytes encoded as with
<code>OUTPUT_FORMAT=raw</code>, but attributes will be encoded as an <code>"attributeMap"</code> field
that contains a JSON object. This is the same format as produced by ingestion-beam
when using <code>--outputType=file</code> and <code>--outputFileFormat=json</code>.</p>
<h3 id="google-cloud-storage-file-prefix">Google Cloud Storage file prefix</h3>
<p>Google Cloud Storage files are named like:</p>
<pre><code>$OUTPUT_BUCKET/{UUID.randomUUID().toString()}.ndjson
</code></pre>
<p>or if <code>OUTPUT_TABLE</code> and <code>BIG_QUERY_OUTPUT_MODE</code> are specified:</p>
<pre><code>$OUTPUT_BUCKET/OUTPUT_TABLE=$OUTPUT_TABLE/{UUID.randomUUID().toString()}.ndjson
</code></pre>
<p>for example, with <code>OUTPUT_BUCKET=gs://test-bucket/test-output</code>:</p>
<pre><code>gs://test-bucket/test-output/ad715b24-7500-45e2-9691-cb91e3b9c2cc.ndjson
</code></pre>
<p>or with <code>OUTPUT_BUCKET=gs://test-bucket/test-output</code>, <code>OUTPUT_TABLE=my_dataset.raw_table</code>, and
<code>BIG_QUERY_OUTPUT_MODE=file_loads</code>:</p>
<pre><code>gs://test-bucket/test-output/OUTPUT_TABLE=my_dataset.raw_table/3b17c648-f8b9-4250-bdc1-5c2e472fdc26.ndjson
</code></pre>
<h2 id="executing">Executing</h2>
<h3 id="locally-with-docker">Locally with Docker</h3>
<p>The provided <code>bin/mvn</code> script downloads and runs maven via docker so that less
setup is needed on the local machine. For prolonged development performance is
likely to be significantly better, especially in MacOS, if <code>mvn</code> is installed and
run natively without docker.</p>
<pre><code class="language-bash"># create a test input file
mkdir -p tmp/
echo '{&quot;payload&quot;:&quot;dGVzdA==&quot;,&quot;attributeMap&quot;:{&quot;host&quot;:&quot;test&quot;}}' &gt; tmp/input.ndjson

# consume messages from the test file, decode and re-encode them, and write to a directory
PASS_ENV=&quot;INPUT_PIPE=tmp/input.ndjson OUTPUT_PIPE=tmp/output.ndjson&quot; ./bin/mvn compile exec:java

# check that the message was delivered
cat tmp/output.ndjson

# read message from stdin and write to stdout
cat tmp/input.ndjson | PASS_ENV=&quot;INPUT_PIPE=- OUTPUT_PIPE=-&quot; ./bin/mvn compile exec:java

# read message from stdin and write to gcs
# note that $ needs to be escaped with \ to prevent shell substitution
cat tmp/input.ndjson | PASS_ENV=&quot;\
  INPUT_PIPE=- \
  OUTPUT_BUCKET=gs://my_bucket/\${document_type:-UNSPECIFIED}/ \
&quot; ./bin/mvn compile exec:java
</code></pre>
<h3 id="locally-without-docker">Locally without Docker</h3>
<p>If you install Java and maven, you can invoke <code>VAR=... mvn</code> in the above commands
instead of using <code>PASS_ENV="VAR=..." ./bin/mvn</code>. Be aware that Java 11 is the target JVM and some
reflection warnings may be thrown on newer versions. Though these are generally
harmless, you may need to comment out the
<code>&lt;compilerArgument&gt;-Werror&lt;/compilerArgument&gt;</code> line in the <code>pom.xml</code> in the git
root.</p>
<pre><code class="language-bash"># consume messages from the test file, decode and re-encode them, and write to a directory
INPUT_PIPE=tmp/input.ndjson OUTPUT_PIPE=tmp/output.ndjson mvn compile exec:java

# read message from stdin and write to stdout
cat tmp/input.ndjson | INPUT_PIPE=- OUTPUT_PIPE=- ./bin/mvn compile exec:java
</code></pre>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../ingestion-beam/sink-job/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Sink Job" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Sink Job
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.expand"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.409db549.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.56a63758.min.js"></script>
      
    
  </body>
</html>