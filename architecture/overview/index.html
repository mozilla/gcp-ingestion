
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Mozilla Telemetry ingestion on Google Cloud Platform">
      
      
        <meta name="author" content="Mozilla Data Platform Team">
      
      
      
        <link rel="prev" href="../..">
      
      
        <link rel="next" href="../bigquery_sink_specification/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.8">
    
    
      
        <title>Overview - GCP Ingestion</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.ded33207.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="indigo">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#gcp-ingestion-architecture" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="GCP Ingestion" class="md-header__button md-logo" aria-label="GCP Ingestion" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            GCP Ingestion
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Overview
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/mozilla/gcp-ingestion/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="./" class="md-tabs__link md-tabs__link--active">
        Architecture
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../ingestion-edge/" class="md-tabs__link">
        ingestion-edge
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../ingestion-beam/" class="md-tabs__link">
        ingestion-beam
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../ingestion-sink/" class="md-tabs__link">
        ingestion-sink
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="GCP Ingestion" class="md-nav__button md-logo" aria-label="GCP Ingestion" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    GCP Ingestion
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/mozilla/gcp-ingestion/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Architecture
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Architecture
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Overview
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Overview
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture-diagram" class="md-nav__link">
    Architecture Diagram
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture-components" class="md-nav__link">
    Architecture Components
  </a>
  
    <nav class="md-nav" aria-label="Architecture Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ingestion-edge" class="md-nav__link">
    Ingestion Edge
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#raw-sink" class="md-nav__link">
    Raw Sink
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decoder" class="md-nav__link">
    Decoder
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#republisher" class="md-nav__link">
    Republisher
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#live-sink" class="md-nav__link">
    Live Sink
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decoded-sink" class="md-nav__link">
    Decoded Sink
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notes" class="md-nav__link">
    Notes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#design-decisions" class="md-nav__link">
    Design Decisions
  </a>
  
    <nav class="md-nav" aria-label="Design Decisions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kubernetes-engine-and-pubsub" class="md-nav__link">
    Kubernetes Engine and PubSub
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#different-topics-for-raw-and-validated-data" class="md-nav__link">
    Different topics for "raw" and "validated" data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bigquery" class="md-nav__link">
    BigQuery
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#archive-messages-from-each-stage-of-the-pipeline-as-json-payloads-in-bigquery" class="md-nav__link">
    Archive messages from each stage of the pipeline as JSON payloads in BigQuery
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-destination-tables" class="md-nav__link">
    Use destination tables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-views-for-user-facing-data" class="md-nav__link">
    Use views for user-facing data
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#limits" class="md-nav__link">
    Limits
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-reading" class="md-nav__link">
    Further Reading
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
          Architecture
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Architecture
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../bigquery_sink_specification/" class="md-nav__link">
        Live Sink Service Specification
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../decoder_service_specification/" class="md-nav__link">
        Decoder Service Specification
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../differences_from_aws/" class="md-nav__link">
        Differences from AWS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../edge_migration_plan/" class="md-nav__link">
        Plans for migrating edge traffic to GCP Ingestion
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../edge_service_specification/" class="md-nav__link">
        Edge Service Specification
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../landfill_service_specification/" class="md-nav__link">
        Raw Sink Service Specification
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../pain_points/" class="md-nav__link">
        Pain points
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reliability/" class="md-nav__link">
        Reliability
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../test_requirements/" class="md-nav__link">
        Test Requirements
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          ingestion-edge
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          ingestion-edge
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ingestion-edge/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          ingestion-beam
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          ingestion-beam
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ingestion-beam/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_2" >
      
      
      
        <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
          Ingestion beam
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Ingestion beam
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ingestion-beam/contextual-services-job/" class="md-nav__link">
        Contextual Services Reporter Job
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ingestion-beam/decoder-job/" class="md-nav__link">
        Decoder Job
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ingestion-beam/ingestion_testing_workflow/" class="md-nav__link">
        Ingestion Testing Workflow
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ingestion-beam/rally-job/" class="md-nav__link">
        Rally Decoder Job
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ingestion-beam/republisher-job/" class="md-nav__link">
        Republisher Job
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ingestion-beam/sink-job/" class="md-nav__link">
        Sink Job
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          ingestion-sink
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          ingestion-sink
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ingestion-sink/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture-diagram" class="md-nav__link">
    Architecture Diagram
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture-components" class="md-nav__link">
    Architecture Components
  </a>
  
    <nav class="md-nav" aria-label="Architecture Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ingestion-edge" class="md-nav__link">
    Ingestion Edge
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#raw-sink" class="md-nav__link">
    Raw Sink
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decoder" class="md-nav__link">
    Decoder
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#republisher" class="md-nav__link">
    Republisher
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#live-sink" class="md-nav__link">
    Live Sink
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decoded-sink" class="md-nav__link">
    Decoded Sink
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notes" class="md-nav__link">
    Notes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#design-decisions" class="md-nav__link">
    Design Decisions
  </a>
  
    <nav class="md-nav" aria-label="Design Decisions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kubernetes-engine-and-pubsub" class="md-nav__link">
    Kubernetes Engine and PubSub
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#different-topics-for-raw-and-validated-data" class="md-nav__link">
    Different topics for "raw" and "validated" data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bigquery" class="md-nav__link">
    BigQuery
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#archive-messages-from-each-stage-of-the-pipeline-as-json-payloads-in-bigquery" class="md-nav__link">
    Archive messages from each stage of the pipeline as JSON payloads in BigQuery
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-destination-tables" class="md-nav__link">
    Use destination tables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-views-for-user-facing-data" class="md-nav__link">
    Use views for user-facing data
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#limits" class="md-nav__link">
    Limits
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-reading" class="md-nav__link">
    Further Reading
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="gcp-ingestion-architecture">GCP Ingestion Architecture</h1>
<p>This document specifies the architecture for GCP Ingestion as a whole.</p>
<h2 id="architecture-diagram">Architecture Diagram</h2>
<p><img alt="diagram.mmd" src="../diagram.svg" title="Architecture Diagram" /></p>
<ul>
<li>The Kubernetes <code>Ingestion Edge</code> sends messages from <code>Producers</code> (e.g.
  Firefox) to a set of PubSub <code>Raw Topics</code>, routing messages based on <code>uri</code></li>
<li><code>Raw Topics</code> are the first layer of a "pipeline family"; the diagram shows
  only the "structured" pipeline family, but there are also deployments
  for "telemetry", "stub-installer", and "pioneer"</li>
<li>The <code>Raw Sink</code> job copies messages from a PubSub <code>Raw Topic</code> to
  <code>BigQuery</code></li>
<li>The Dataflow <code>Decoder</code> job decodes messages from the PubSub <code>Raw Topic</code> to
  the PubSub <code>Decoded Topic</code></li>
<li>The Dataflow <code>Republisher</code> job reads messages from the PubSub <code>Decoded Topic</code>
  and republishes them to various
  lower volume derived topics including <code>Monitoring Sample Topics</code> and
  <code>Per DocType Topics</code></li>
<li>The Kubernetes <code>Decoded Sink</code> job copies messages from the PubSub <code>Decoded Topic</code>
  to <code>BigQuery</code> with the payload encoded as JSON</li>
<li>The Kubernetes <code>Live Sink</code> job copies messages from the PubSub <code>Decoded Topic</code>
  to <code>BigQuery</code> with the payload structure parsed out to individual fields</li>
</ul>
<h2 id="architecture-components">Architecture Components</h2>
<h3 id="ingestion-edge">Ingestion Edge</h3>
<ul>
<li>Must send messages from producers to PubSub topics</li>
<li>Must store messages on disk when PubSub is unavailable</li>
<li>Must attempt to deliver all new messages to PubSub before storing on disk</li>
<li>Must not be scaled down when there are messages on disk</li>
<li>Must respond server error if PubSub and disk are both unavailable</li>
<li>Must use a 5XX error error code</li>
<li>Must accept configuration mapping <code>uri</code> to PubSub Topic</li>
<li>Expected initial topics are Structured Ingestion, Telemetry, and Pioneer</li>
<li>Must accept configuration defining HTTP headers to capture</li>
</ul>
<h3 id="raw-sink">Raw Sink</h3>
<ul>
<li>Must copy messages from PubSub topics to BigQuery</li>
<li>This copy may be for backfill, recovery, or testing</li>
<li>Must not ack messages read from PubSub until they are delivered</li>
<li>Must accept configuration mapping PubSub topics to BigQuery tables</li>
<li>Should retry transient Cloud Storage errors indefinitely</li>
<li>Should use exponential back-off to determine retry timing</li>
</ul>
<h3 id="decoder">Decoder</h3>
<ul>
<li>Must decode messages from PubSub topics to PubSub topics</li>
<li>Must not ack messages read from PubSub until they are delivered</li>
<li>Must apply the following transforms in order
  (<a href="../../ingestion-beam/src/main/java/com/mozilla/telemetry/decoder/">implementations here</a>):</li>
<li>Parse <code>x_pipeline_proxy</code> attribute; if present with a valid value in
     <a href="https://github.com/mozilla/gcp-ingestion/blob/main/docs/edge.md#submission-timestamp-format">the edge submission timestamp format</a>,
     archive the value of <code>submission_timestamp</code> to <code>proxy_timestamp</code> and
     replace with the <code>x_pipeline_proxy</code> value</li>
<li>Resolve GeoIP from <code>remote_addr</code> or <code>x_forwarded_for</code> attribute into
     <code>geo_*</code> attributes</li>
<li>Parse <code>uri</code> attribute into multiple attributes</li>
<li>Gzip decompress <code>payload</code> if gzip compressed</li>
<li>Validate <code>payload</code> using a JSON Schema determined by attributes</li>
<li>Parse <code>agent</code> attribute into <code>user_agent_*</code> attributes</li>
<li>Produce <code>normalized_</code> variants of select attributes</li>
<li>Sanitize attributes, configurable per document type via schema metadata</li>
<li>Inject <code>normalized_</code> attributes at the top level and other select
     attributes into a nested <code>metadata</code> top level key in <code>payload</code></li>
<li>Should deduplicate messages based on the <code>uri</code> attribute</li>
<li>Must ensure at least once delivery, so deduplication is only "best effort"</li>
<li>Must send messages rejected by transforms to a configurable error destination</li>
<li>Must allow error destination in BigQuery</li>
</ul>
<h3 id="republisher">Republisher</h3>
<ul>
<li>Must copy messages from PubSub topics to PubSub topics</li>
<li>Must ack messages read from PubSub after they are delivered to all
  matching destinations</li>
<li>Must not ack messages read from PubSub before they are delivered to all
  matching destinations</li>
<li>Must accept configuration enabling republishing of messages to a debug
  topic if they contain an <code>x_debug_id</code> attribute</li>
<li>Must accept configuration enabling or disabling debug republishing</li>
<li>Must accept configuration for the destination topic</li>
<li>Must accept configuration enabling republishing of a random sample of the
  input stream</li>
<li>Must accept configuration for the sample ratio</li>
<li>Must accept configuration for the destination topic</li>
<li>Must accept configuration mapping <code>document_type</code>s to PubSub topics</li>
<li>Must accept configuration for the destination topic pattern</li>
<li>Must accept configuration for which <code>document_type</code>s to republish</li>
<li>Must only deliver messages with configured destinations</li>
<li>Must accept configuration mapping <code>document_namespace</code>s to PubSub topics</li>
<li>Must accept configuration for a map from <code>document_namespace</code>s to topics</li>
<li>Must only deliver messages with configured destinations</li>
<li>Must accept optional configuration for sampling telemetry data</li>
<li>Must accept configuration for the destination topic pattern</li>
<li>Must accept configuration for the sampling ratio for each channel (nightly,
    beta, and release)</li>
</ul>
<h3 id="live-sink">Live Sink</h3>
<ul>
<li>Must copy messages from PubSub topics to BigQuery</li>
<li>Must not ack messages read from PubSub until they are delivered</li>
<li>Must accept configuration mapping PubSub topics to BigQuery tables</li>
<li>Must accept configuration for using streaming or batch loads</li>
<li>Must transform all field names to lowercase with underscores (<code>snake_case</code>)
  and perform other field name cleaning to match the transformations
  expected by the <a href="https://github.com/mozilla/jsonschema-transpiler"><code>jsonschema-transpiler</code></a></li>
<li>Must set <a href="https://beam.apache.org/releases/javadoc/2.7.0/org/apache/beam/sdk/io/gcp/bigquery/BigQueryIO.Write.html#ignoreUnknownValues--"><code>ignoreUnknownValues</code></a>
  to <code>true</code></li>
<li>Should retry transient BigQuery errors indefinitely</li>
<li>Should use exponential back-off to determine retry timing</li>
<li>Must send messages rejected by BigQuery to a configurable error destination</li>
<li>Must allow error destinations in BigQuery</li>
</ul>
<h3 id="decoded-sink">Decoded Sink</h3>
<ul>
<li>Must copy messages from PubSub topics to BigQuery</li>
<li>May be used to backfill BigQuery columns previously unspecified in the
    table schema</li>
<li>May be used by BigQuery, Spark, and Dataflow to access columns missing
    from BigQuery Tables</li>
<li>Must not ack messages read from PubSub until they are delivered</li>
<li>Must accept configuration mapping PubSub topics to BigQuery tables</li>
<li>Should retry transient BigQuery errors indefinitely</li>
<li>Should use exponential back-off to determine retry timing</li>
</ul>
<h3 id="notes">Notes</h3>
<p>PubSub stores unacknowledged messages for 7 days. Any PubSub subscription more
than 7 days behind requires a backfill.</p>
<p>Dataflow will extend ack deadlines indefinitely when consuming messages, and
will not ack messages until they are processed by an output or <code>GroupByKey</code>
transform.</p>
<p>Dataflow jobs achieve at least once delivery by <em>not</em> using GroupByKey
transforms and <em>not</em> falling more than 7 days behind in processing.</p>
<h2 id="design-decisions">Design Decisions</h2>
<h3 id="kubernetes-engine-and-pubsub">Kubernetes Engine and PubSub</h3>
<p>Kubernetes Engine is a scalable, managed service based on an industry standard.
PubSub is a simple, scalable, managed service. By comparison a compute instance
group instead of Kubernetes Engine and Kafka instead of PubSub would require
more operational overhead and engineering effort for maintenance.</p>
<h3 id="different-topics-for-raw-and-validated-data">Different topics for "raw" and "validated" data</h3>
<p>We don't want to have to repeat the validation logic in the case where we have
multiple consumers of the data. Raw data can be sent to a single topic to
simplify the edge service and then validated data can be sent to topics split
by <code>docType</code> and other attributes, in order to allow consumers for specific
sets of data.</p>
<h3 id="bigquery">BigQuery</h3>
<p>BigQuery provides a simple, scalable, managed service for executing SQL queries
over arbitrarily large or small amounts of data, with built-in schema
validation, hyperloglog functions, UDF support, and destination tables
(sometimes called materialized views) for minimizing cost and latency of
derived tables. Alternatives (such as Presto) would have more operational
overhead and engineering effort for maintenance, while generally being less
featureful.</p>
<h3 id="archive-messages-from-each-stage-of-the-pipeline-as-json-payloads-in-bigquery">Archive messages from each stage of the pipeline as JSON payloads in BigQuery</h3>
<p>One of the primary challenges of building a real-world data pipeline is
anticipating and adapting to changes in the schemas of messages flowing through
the system. Strong schemas and structured data give us many usability and
performance benefits, but changes to the schema at one point in the pipeline
can lead to processing errors or dropped data further down the pipeline.</p>
<p>Saving JSON messages as compressed bytes fields in BigQuery tables allows
use to gracefully handle new fields added upstream without needing to specify
those fields completely before they are stored. New columns can be added to a
table's schema and then restored via a backfill operation.</p>
<h3 id="use-destination-tables">Use destination tables</h3>
<p>For complex queries that are calculated over time-based windows of data, using
destination tables allows us to save time and cost by only querying each new
window of data once.</p>
<h3 id="use-views-for-user-facing-data">Use views for user-facing data</h3>
<p>Views we create in BigQuery can be a stable interface for users while we
potentially change versions or implementations of a pipeline behind the scenes.
If we wanted to rewrite a materialized view, for example, we might run the new
and old definitions in parallel, writing to separate tables; when we’re
comfortable that the new implementation is stable, we could cut users over to
the new implementation by simply changing the definition of the user-facing
view.</p>
<h2 id="limits">Limits</h2>
<ul>
<li>The maximum <code>Content-Length</code> accepted at the edge is 1 MB; larger payloads
  will be dropped and <a href="https://mozilla.github.io/gcp-ingestion/architecture/edge_service_specification/#server-requestresponse">the request will return a 413 response code</a></li>
<li>The maximum payload size after being decompressed in the Decoder is 8 MB;
  larger payloads will trigger a <code>PayloadTooLarge</code> exception and be sent to
  error output</li>
<li>Hard limit of 10,000 columns per table in BigQuery (see <a href="https://cloud.google.com/bigquery/quotas#load_jobs">Load job limits</a>)</li>
<li>Max of 1,000,000 streaming inserts per second per BigQuery table, lower if we populate <code>insertId</code> (see <a href="https://cloud.google.com/bigquery/quotas#streaming_inserts">Streaming insert limits</a>)</li>
<li>A PubSub topic without any subscriptions drops all messages until a subscription is created</li>
<li>API Rate Limit: 20 req/sec</li>
</ul>
<h2 id="further-reading">Further Reading</h2>
<p><a href="../differences_from_aws/">Differences from AWS</a></p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.expand"], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.51198bba.min.js"></script>
      
    
  </body>
</html>