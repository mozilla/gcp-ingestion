<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Mozilla Data Platform Team">
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Pain Points - GCP Ingestion</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">GCP Ingestion</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../..">Home</a>
                            </li>
                            <li >
                                <a href="../../ingestion-edge/">ingestion-edge</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">ingestion-beam <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../ingestion-beam/">Overview</a>
</li>
                                    
<li >
    <a href="../../ingestion-beam/ingestion_testing_workflow/">Ingestion testing workflow</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Architecture <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../overview/">Overview</a>
</li>
                                    
<li >
    <a href="../differences_from_aws/">Differences from AWS</a>
</li>
                                    
<li class="active">
    <a href="./">Pain Points</a>
</li>
                                    
<li >
    <a href="../edge_migration_plan/">Edge Migration Plan</a>
</li>
                                    
<li >
    <a href="../reliability/">Reliability</a>
</li>
                                    
<li >
    <a href="../test_requirements/">Test requirements</a>
</li>
                                    
<li >
    <a href="../landfill_service_specification/">Landfill Service Specification</a>
</li>
                                    
<li >
    <a href="../edge_service_specification/">Edge Server Specification</a>
</li>
                                    
<li >
    <a href="../bigquery_sink_specification/">BigQuery Sink Specification</a>
</li>
                                    
<li >
    <a href="../decoder_service_specification/">Decoder Service Specification</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>

                            <li>
                                <a href="https://github.com/mozilla/gcp-ingestion/edit/master/docs/architecture/pain_points.md"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#pain-points">Pain points</a></li>
        <li class="main "><a href="#app-engine">App Engine</a></li>
        <li class="main "><a href="#dataflow">Dataflow</a></li>
            <li><a href="#bigqueryiowrite">BigQueryIO.Write</a></li>
            <li><a href="#fileiowrite">FileIO.Write</a></li>
            <li><a href="#pubsubiowrite">PubsubIO.Write</a></li>
            <li><a href="#templates">Templates</a></li>
        <li class="main "><a href="#pubsub">PubSub</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="pain-points">Pain points</h1>
<p>A running list of things that are suboptimal in GCP.</p>
<h1 id="app-engine">App Engine</h1>
<p>For network-bound applications it can be prohibitively expensive. A PubSub push
subscription application that decodes protobuf and forwards messages to the
ingestion-edge used <code>~300</code> instances at <code>$0.06</code> per instance hour to handle
<code>~5krps</code>, which is <code>~$13K/mo</code>.</p>
<h1 id="dataflow">Dataflow</h1>
<p>Replaces certain components with custom behavior that is not part of the open
source Beam API, making it so they can't be extended (e.g. to expose a stream
of messages that have been delivered to PubSub).</p>
<h2 id="bigqueryiowrite"><code>BigQueryIO.Write</code></h2>
<p>Requires decoding <code>PubsubMessage.payload</code> from JSON to a <code>TableRow</code>, which gets
encoded as JSON to be sent to BigQuery.</p>
<p>Crashes the pipeline when the destination table does not exist.</p>
<h2 id="fileiowrite"><code>FileIO.Write</code></h2>
<p>Acknowledges messages in PubSub before they are written to accumulate data
across multiple <a href="https://beam.apache.org/documentation/execution-model/#bundling-and-persistence">bundles</a> and produce reasonably sized files. Possible
workaround being investigated in <a href="https://github.com/mozilla/gcp-ingestion/issues/380">#380</a>. This also effects <code>BigQueryIO.Write</code>
in batch mode.</p>
<h2 id="pubsubiowrite"><code>PubsubIO.Write</code></h2>
<p>Does not support dynamic destinations.</p>
<p>Does not support [<code>NestedValueProvider</code>] for destinations in streaming mode on
Dataflow, which is needed to create templates that accept a mapping of document
type to a predetermined number of destinations. This is because Dataflow moves
the implementation into the shuffler to improve performance. Current workaround
is to specify mapping at template creation time.</p>
<p>Does not use standard client library.</p>
<p>Does not expose an output of delivered messages, which is needed for at least
once delivery with deduplication. Current workaround is to get delivered
messages from a subscription to the output PubSub topic.</p>
<p>Uses HTTPS JSON API, which increases message payload size vs protobuf by 25%
for base64 encoding and causes some messages to exceed the 10MB request size
limit that otherwise would not.</p>
<h2 id="templates">Templates</h2>
<p>Does not support repeated parameters via <code>ValueProvider&lt;List&lt;...&gt;&gt;</code>, as
described in [Dataflow Java SDK #632]</p>
<h1 id="pubsub">PubSub</h1>
<p>Can be prohibitively expensive. It costs
<a href="https://cloud.google.com/products/calculator/#id=9bb92e31-ea3f-475b-afff-52da0796e0a7"><code>~$51K/mo</code></a>
to use PubSub with a <code>70MiB/s</code> stream published or consumed 7 times (Edge to
raw topic, raw topic to Cloud Storage, raw topic to Decoder, Decoder to decoded
topic, decoded topic to Decoder for deduplication, decoded topic to Cloud
Storage, decoded topic to BigQuery).</p>
<p>Push Subscriptions are limited to <code>min(10MB, 1000 messages)</code> in flight, making
the theoretical maximum parallel latency per message ~<code>62ms</code> to achieve
<code>16krps</code>.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
