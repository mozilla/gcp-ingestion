<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Mozilla Data Platform Team">
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Differences from AWS - GCP Ingestion</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">GCP Ingestion</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../..">Home</a>
                            </li>
                            <li >
                                <a href="../../ingestion-edge/">ingestion-edge</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">ingestion-beam <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../ingestion-beam/">Overview</a>
</li>
                                    
<li >
    <a href="../../ingestion-beam/sink-job/">Sink Job</a>
</li>
                                    
<li >
    <a href="../../ingestion-beam/decoder-job/">Decoder Job</a>
</li>
                                    
<li >
    <a href="../../ingestion-beam/republisher-job/">Republisher Job</a>
</li>
                                    
<li >
    <a href="../../ingestion-beam/ingestion_testing_workflow/">Ingestion testing workflow</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Architecture <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../overview/">Overview</a>
</li>
                                    
<li class="active">
    <a href="./">Differences from AWS</a>
</li>
                                    
<li >
    <a href="../pain_points/">Pain Points</a>
</li>
                                    
<li >
    <a href="../edge_migration_plan/">Edge Migration Plan</a>
</li>
                                    
<li >
    <a href="../reliability/">Reliability</a>
</li>
                                    
<li >
    <a href="../test_requirements/">Test requirements</a>
</li>
                                    
<li >
    <a href="../landfill_service_specification/">Landfill Service Specification</a>
</li>
                                    
<li >
    <a href="../edge_service_specification/">Edge Server Specification</a>
</li>
                                    
<li >
    <a href="../bigquery_sink_specification/">BigQuery Sink Specification</a>
</li>
                                    
<li >
    <a href="../decoder_service_specification/">Decoder Service Specification</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>

                            <li>
                                <a href="https://github.com/mozilla/gcp-ingestion/edit/master/docs/architecture/differences_from_aws.md"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#differences-from-aws">Differences from AWS</a></li>
            <li><a href="#replace-heka-framed-protobuf-with-newline-delimited-json">Replace Heka Framed Protobuf with newline delimited JSON</a></li>
            <li><a href="#replace-ec2-edge-with-kubernetes-edge">Replace EC2 Edge with Kubernetes Edge</a></li>
            <li><a href="#replace-kafka-with-pubsub">Replace Kafka with PubSub</a></li>
            <li><a href="#replace-hindsight-data-warehouse-loaders-with-dataflow">Replace Hindsight Data Warehouse Loaders with Dataflow</a></li>
            <li><a href="#replace-s3-with-cloud-storage">Replace S3 with Cloud Storage</a></li>
            <li><a href="#messages-always-delivered-to-message-queue">Messages Always Delivered to Message Queue</a></li>
            <li><a href="#landfill-is-downstream-from-message-queue">Landfill is Downstream from Message Queue</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="differences-from-aws">Differences from AWS</h1>
<p>This document explains how GCP Ingestion differs from the <a href="https://mana.mozilla.org/wiki/display/SVCOPS/Telemetry+-+Data+Pipeline+Architecture">AWS Data Platform
Architecture</a>.</p>
<h2 id="replace-heka-framed-protobuf-with-newline-delimited-json">Replace Heka Framed Protobuf with newline delimited JSON</h2>
<p>Heka framed protobuf requires special code to read and write. Newline delimited
JSON is readable by BigQuery, Dataflow, and Spark using standard libraries. JSON
doesn't enforce a schema, so it can be used to store data with an incomplete
schema and be used to backfill missing columns.</p>
<h2 id="replace-ec2-edge-with-kubernetes-edge">Replace EC2 Edge with Kubernetes Edge</h2>
<p>The AWS data platform uses EC2 instances running an NGinX module to encode HTTP
requests as Heka messages and then write them to Kafka using <code>librdkafka</code> and
directly to files on disk. <code>librdkafka</code> handles buffering and batching when
writing to Kafka. Files on disk are rotated with cron and uploaded to S3. On
shutdown files are forcefully rotated and uploaded. The sizing of the EC2
instance cluster is effectively static, but is configured to scale up if
needed.</p>
<p>The EC2 instances have been replaced with a Kubernetes cluster. This decision
was made by the Cloud Operations team to simplify operational support for them.</p>
<p>The NGinX module has been replaced by an HTTP service running in Docker. A
number of factors informed the decision to rewrite the edge, including:</p>
<ul>
<li>The PubSub equivalent of <code>librdkafka</code> is the <a href="https://cloud.google.com/apis/docs/cloud-client-libraries">google client
  libraries</a>,
  which do not have a C implementation</li>
<li>We can simplify the edge by uploading to landfill after PubSub while
  remaining resilient to Dataflow and PubSub failures, because PubSub durably
  stores unacknowledged messages for 7 days</li>
<li>We can simplify disaster recovery by Ensuring that all data eventually flows
  through PubSub</li>
<li>In the AWS edge data only flows to at least one of Kafka or landfill</li>
<li>We can allow Kubernetes to auto scale when PubSub is available by only
  queuing requests to disk only when they cannot be delivered to PubSub</li>
<li>We can ensure that data is not lost on shutdown by disabling auto scaling
  down when there are requests on disk</li>
</ul>
<h2 id="replace-kafka-with-pubsub">Replace Kafka with PubSub</h2>
<p>Comparison:</p>
<table>
<thead>
<tr>
<th></th>
<th>Kafka in AWS Data Pipeline</th>
<th>PubSub</th>
</tr>
</thead>
<tbody>
<tr>
<td>Managed by</td>
<td>Ops</td>
<td>Google</td>
</tr>
<tr>
<td>Access control</td>
<td>Security groups, all-or-nothing</td>
<td>Cloud IAM, per-topic</td>
</tr>
<tr>
<td>Scaling</td>
<td>Manual</td>
<td>Automatic</td>
</tr>
<tr>
<td>Cost</td>
<td>Per EC2 instance</td>
<td>Per GB, min charge 1 KB/req</td>
</tr>
<tr>
<td>Data Storage</td>
<td>Configured in GB per EC2 instance</td>
<td>7 days for unacknowledged</td>
</tr>
<tr>
<td>Cross region</td>
<td>no</td>
<td>yes</td>
</tr>
</tbody>
</table>
<h2 id="replace-hindsight-data-warehouse-loaders-with-dataflow">Replace Hindsight Data Warehouse Loaders with Dataflow</h2>
<p>Dataflow advantages:</p>
<ul>
<li>Connectors for PubSub, Cloud Storage, and BigQuery built-in</li>
<li>Seamlessly supports streaming and batch sources and sinks</li>
<li>Runs on managed service and has simple local runner for testing and
  development</li>
<li>Auto scales on input volume</li>
</ul>
<h2 id="replace-s3-with-cloud-storage">Replace S3 with Cloud Storage</h2>
<p>They are equivalent products for the different cloud vendors.</p>
<h2 id="messages-always-delivered-to-message-queue">Messages Always Delivered to Message Queue</h2>
<p>In AWS the edge aimed to ensure messages were always delivered to either Kafka
or landfill, and in the case of an outage one could be backfilled from the
other. On GCP the Kubernetes edge aims to ensure messages are always delivered
to PubSub. This ensures that consumers from PubSub never miss data unless they
fall too far behind. It also allows landfill to be handled downstream from
PubSub (see below).</p>
<h2 id="landfill-is-downstream-from-message-queue">Landfill is Downstream from Message Queue</h2>
<p>In AWS, the failsafe data store was upstream of the message queue (Kafka). On
GCP, the failsafe data store is downstream from the message queue (PubSub).</p>
<p>This makes the edge and Dataflow landfill loader simpler. The edge doesn’t have
to ensure that pending messages are safely offloaded on shutdown, because
messages are only left pending when PubSub is unavailable, and scaling down is
disabled while messages are pending. The Dataflow landfill loader doesn’t have
to ensure pending messages are safely offloaded because it only acks messages
after they are uploaded, ensuring at least once delivery.</p>
<p>This design is possible because of two changes compared to our AWS
implementation. First, the Kubernetes edge eventually delivers all messages to
PubSub. In AWS if Kafka were down then messages would only be delivered
directly to landfill, and would never flow through Kafka. This change ensures
that if all messages are consumed from PubSub then no messages have been
skipped. Second, PubSub stores unacknowledged messages for 7 days. In AWS Kafka
stores messages for 2-3 days, depending on topic and total message volume. This
change ensures that we have sufficient time to reliably consume all messages
before they are dropped from the queue, even if total message volume changes
dramatically or consumers are not highly available and suffer an outage over a
holiday weekend.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
