
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Mozilla Telemetry ingestion on Google Cloud Platform">
      
      
      
        <meta name="author" content="Mozilla Data Platform Team">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.2.5">
    
    
      
        <title>Differences from AWS - GCP Ingestion</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.be71726b.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.3f5d1f46.min.css">
        
          
          
          <meta name="theme-color" content="#009485">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="teal" data-md-color-accent="">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#differences-from-aws" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="GCP Ingestion" class="md-header__button md-logo" aria-label="GCP Ingestion" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            GCP Ingestion
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Differences from AWS
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/mozilla/gcp-ingestion/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../overview/" class="md-tabs__link md-tabs__link--active">
        Architecture
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../ingestion-edge/" class="md-tabs__link">
        ingestion-edge
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../ingestion-beam/" class="md-tabs__link">
        ingestion-beam
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../ingestion-sink/" class="md-tabs__link">
        ingestion-sink
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="GCP Ingestion" class="md-nav__button md-logo" aria-label="GCP Ingestion" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    GCP Ingestion
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/mozilla/gcp-ingestion/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      <label class="md-nav__link" for="__nav_2">
        Architecture
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Architecture" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Architecture
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" checked>
      
      <label class="md-nav__link" for="__nav_2_2">
        Architecture
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Architecture" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Architecture
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../bigquery_sink_specification/" class="md-nav__link">
        Live Sink Service Specification
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../decoder_service_specification/" class="md-nav__link">
        Decoder Service Specification
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Differences from AWS
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Differences from AWS
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#replace-heka-framed-protobuf-with-newline-delimited-json" class="md-nav__link">
    Replace Heka Framed Protobuf with newline delimited JSON
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#replace-ec2-edge-with-kubernetes-edge" class="md-nav__link">
    Replace EC2 Edge with Kubernetes Edge
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#replace-kafka-with-pubsub" class="md-nav__link">
    Replace Kafka with PubSub
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#replace-hindsight-data-warehouse-loaders-with-dataflow" class="md-nav__link">
    Replace Hindsight Data Warehouse Loaders with Dataflow
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#replace-s3-with-cloud-storage" class="md-nav__link">
    Replace S3 with Cloud Storage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#messages-always-delivered-to-message-queue" class="md-nav__link">
    Messages Always Delivered to Message Queue
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#landfill-is-downstream-from-message-queue" class="md-nav__link">
    Landfill is Downstream from Message Queue
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../edge_migration_plan/" class="md-nav__link">
        Plans for migrating edge traffic to GCP Ingestion
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../edge_service_specification/" class="md-nav__link">
        Edge Service Specification
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../landfill_service_specification/" class="md-nav__link">
        Raw Sink Service Specification
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../pain_points/" class="md-nav__link">
        Pain points
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../reliability/" class="md-nav__link">
        Reliability
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../test_requirements/" class="md-nav__link">
        Test Requirements
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" data-md-state="indeterminate" type="checkbox" id="__nav_3" checked>
      
      <label class="md-nav__link" for="__nav_3">
        ingestion-edge
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="ingestion-edge" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          ingestion-edge
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ingestion-edge/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" data-md-state="indeterminate" type="checkbox" id="__nav_4" checked>
      
      <label class="md-nav__link" for="__nav_4">
        ingestion-beam
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="ingestion-beam" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          ingestion-beam
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ingestion-beam/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" data-md-state="indeterminate" type="checkbox" id="__nav_4_2" checked>
      
      <label class="md-nav__link" for="__nav_4_2">
        Ingestion beam
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Ingestion beam" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Ingestion beam
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ingestion-beam/decoder-job/" class="md-nav__link">
        Decoder Job
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ingestion-beam/ingestion_testing_workflow/" class="md-nav__link">
        Ingestion Testing Workflow
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ingestion-beam/rally-job/" class="md-nav__link">
        Rally Decoder Job
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ingestion-beam/republisher-job/" class="md-nav__link">
        Republisher Job
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ingestion-beam/sink-job/" class="md-nav__link">
        Sink Job
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" data-md-state="indeterminate" type="checkbox" id="__nav_5" checked>
      
      <label class="md-nav__link" for="__nav_5">
        ingestion-sink
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="ingestion-sink" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          ingestion-sink
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ingestion-sink/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#replace-heka-framed-protobuf-with-newline-delimited-json" class="md-nav__link">
    Replace Heka Framed Protobuf with newline delimited JSON
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#replace-ec2-edge-with-kubernetes-edge" class="md-nav__link">
    Replace EC2 Edge with Kubernetes Edge
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#replace-kafka-with-pubsub" class="md-nav__link">
    Replace Kafka with PubSub
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#replace-hindsight-data-warehouse-loaders-with-dataflow" class="md-nav__link">
    Replace Hindsight Data Warehouse Loaders with Dataflow
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#replace-s3-with-cloud-storage" class="md-nav__link">
    Replace S3 with Cloud Storage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#messages-always-delivered-to-message-queue" class="md-nav__link">
    Messages Always Delivered to Message Queue
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#landfill-is-downstream-from-message-queue" class="md-nav__link">
    Landfill is Downstream from Message Queue
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/mozilla/gcp-ingestion/edit/master/docs/architecture/differences_from_aws.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="differences-from-aws">Differences from AWS</h1>
<p>This document explains how GCP Ingestion differs from the <a href="https://mana.mozilla.org/wiki/display/SVCOPS/Telemetry+-+Data+Pipeline+Architecture">AWS Data Platform
Architecture</a>.</p>
<h2 id="replace-heka-framed-protobuf-with-newline-delimited-json">Replace Heka Framed Protobuf with newline delimited JSON</h2>
<p>Heka framed protobuf requires special code to read and write. Newline delimited
JSON is readable by BigQuery, Dataflow, and Spark using standard libraries. JSON
doesn't enforce a schema, so it can be used to store data with an incomplete
schema and be used to backfill missing columns.</p>
<h2 id="replace-ec2-edge-with-kubernetes-edge">Replace EC2 Edge with Kubernetes Edge</h2>
<p>The AWS data platform uses EC2 instances running an NGinX module to encode HTTP
requests as Heka messages and then write them to Kafka using <code>librdkafka</code> and
directly to files on disk. <code>librdkafka</code> handles buffering and batching when
writing to Kafka. Files on disk are rotated with cron and uploaded to S3. On
shutdown files are forcefully rotated and uploaded. The sizing of the EC2
instance cluster is effectively static, but is configured to scale up if
needed.</p>
<p>The EC2 instances have been replaced with a Kubernetes cluster. This decision
was made by the Cloud Operations team to simplify operational support for them.</p>
<p>The NGinX module has been replaced by an HTTP service running in Docker. A
number of factors informed the decision to rewrite the edge, including:</p>
<ul>
<li>The PubSub equivalent of <code>librdkafka</code> is the <a href="https://cloud.google.com/apis/docs/cloud-client-libraries">google client
  libraries</a>,
  which do not have a C implementation</li>
<li>We can simplify the edge by uploading to landfill after PubSub while
  remaining resilient to Dataflow and PubSub failures, because PubSub durably
  stores unacknowledged messages for 7 days</li>
<li>We can simplify disaster recovery by Ensuring that all data eventually flows
  through PubSub</li>
<li>In the AWS edge data only flows to at least one of Kafka or landfill</li>
<li>We can allow Kubernetes to auto scale when PubSub is available by only
  queuing requests to disk only when they cannot be delivered to PubSub</li>
<li>We can ensure that data is not lost on shutdown by disabling auto scaling
  down when there are requests on disk</li>
</ul>
<h2 id="replace-kafka-with-pubsub">Replace Kafka with PubSub</h2>
<p>Comparison:</p>
<table>
<thead>
<tr>
<th></th>
<th>Kafka in AWS Data Pipeline</th>
<th>PubSub</th>
</tr>
</thead>
<tbody>
<tr>
<td>Managed by</td>
<td>Ops</td>
<td>Google</td>
</tr>
<tr>
<td>Access control</td>
<td>Security groups, all-or-nothing</td>
<td>Cloud IAM, per-topic</td>
</tr>
<tr>
<td>Scaling</td>
<td>Manual</td>
<td>Automatic</td>
</tr>
<tr>
<td>Cost</td>
<td>Per EC2 instance</td>
<td>Per GB, min charge 1 KB/req</td>
</tr>
<tr>
<td>Data Storage</td>
<td>Configured in GB per EC2 instance</td>
<td>7 days for unacknowledged</td>
</tr>
<tr>
<td>Cross region</td>
<td>no</td>
<td>yes</td>
</tr>
</tbody>
</table>
<h2 id="replace-hindsight-data-warehouse-loaders-with-dataflow">Replace Hindsight Data Warehouse Loaders with Dataflow</h2>
<p>Dataflow advantages:</p>
<ul>
<li>Connectors for PubSub, Cloud Storage, and BigQuery built-in</li>
<li>Seamlessly supports streaming and batch sources and sinks</li>
<li>Runs on managed service and has simple local runner for testing and
  development</li>
<li>Auto scales on input volume</li>
</ul>
<h2 id="replace-s3-with-cloud-storage">Replace S3 with Cloud Storage</h2>
<p>They are equivalent products for the different cloud vendors.</p>
<h2 id="messages-always-delivered-to-message-queue">Messages Always Delivered to Message Queue</h2>
<p>In AWS the edge aimed to ensure messages were always delivered to either Kafka
or landfill, and in the case of an outage one could be backfilled from the
other. On GCP the Kubernetes edge aims to ensure messages are always delivered
to PubSub. This ensures that consumers from PubSub never miss data unless they
fall too far behind. It also allows landfill to be handled downstream from
PubSub (see below).</p>
<h2 id="landfill-is-downstream-from-message-queue">Landfill is Downstream from Message Queue</h2>
<p>In AWS, the failsafe data store was upstream of the message queue (Kafka). On
GCP, the failsafe data store is downstream from the message queue (PubSub).</p>
<p>This makes the edge and Dataflow landfill loader simpler. The edge doesn’t have
to ensure that pending messages are safely offloaded on shutdown, because
messages are only left pending when PubSub is unavailable, and scaling down is
disabled while messages are pending. The Dataflow landfill loader doesn’t have
to ensure pending messages are safely offloaded because it only acks messages
after they are uploaded, ensuring at least once delivery.</p>
<p>This design is possible because of two changes compared to our AWS
implementation. First, the Kubernetes edge eventually delivers all messages to
PubSub. In AWS if Kafka were down then messages would only be delivered
directly to landfill, and would never flow through Kafka. This change ensures
that if all messages are consumed from PubSub then no messages have been
skipped. Second, PubSub stores unacknowledged messages for 7 days. In AWS Kafka
stores messages for 2-3 days, depending on topic and total message volume. This
change ensures that we have sufficient time to reliably consume all messages
before they are dropped from the queue, even if total message volume changes
dramatically or consumers are not highly available and suffer an outage over a
holiday weekend.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../decoder_service_specification/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Decoder Service Specification" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Decoder Service Specification
            </div>
          </div>
        </a>
      
      
        
        <a href="../edge_migration_plan/" class="md-footer__link md-footer__link--next" aria-label="Next: Plans for migrating edge traffic to GCP Ingestion" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Plans for migrating edge traffic to GCP Ingestion
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.expand"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.409db549.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.56a63758.min.js"></script>
      
    
  </body>
</html>