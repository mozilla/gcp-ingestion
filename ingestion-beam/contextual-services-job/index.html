
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Mozilla Telemetry ingestion on Google Cloud Platform">
      
      
        <meta name="author" content="Mozilla Data Platform Team">
      
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../decoder-job/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>Contextual Services Reporter Job - GCP Ingestion</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.e53b48f4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#contextual-services-reporter-job" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="GCP Ingestion" class="md-header__button md-logo" aria-label="GCP Ingestion" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            GCP Ingestion
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Contextual Services Reporter Job
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/mozilla/gcp-ingestion/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../architecture/overview/" class="md-tabs__link">
          
  
  
  Architecture

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../ingestion-edge/" class="md-tabs__link">
          
  
  
  ingestion-edge

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
  ingestion-beam

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../ingestion-sink/" class="md-tabs__link">
          
  
  
  ingestion-sink

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="GCP Ingestion" class="md-nav__button md-logo" aria-label="GCP Ingestion" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    GCP Ingestion
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/mozilla/gcp-ingestion/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/bigquery_sink_specification/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Live Sink Service Specification
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/decoder_service_specification/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Decoder Service Specification
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/differences_from_aws/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Differences from AWS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/edge_migration_plan/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Plans for migrating edge traffic to GCP Ingestion
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/edge_service_specification/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Edge Service Specification
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/landfill_service_specification/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Raw Sink Service Specification
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/pain_points/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pain points
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/reliability/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Reliability
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/test_requirements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Test Requirements
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    ingestion-edge
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            ingestion-edge
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ingestion-edge/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    ingestion-beam
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            ingestion-beam
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" checked>
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Ingestion beam
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Ingestion beam
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Contextual Services Reporter Job
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Contextual Services Reporter Job
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#data-flows-for-contextual-services" class="md-nav__link">
    <span class="md-ellipsis">
      Data flows for Contextual Services
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#beam-pipeline-transforms" class="md-nav__link">
    <span class="md-ellipsis">
      Beam Pipeline Transforms
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Beam Pipeline Transforms">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pubsub-republished-topic" class="md-nav__link">
    <span class="md-ellipsis">
      Pub/Sub republished topic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filterbydoctype" class="md-nav__link">
    <span class="md-ellipsis">
      FilterByDoctype
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verifymetadata" class="md-nav__link">
    <span class="md-ellipsis">
      VerifyMetadata
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decompresspayload" class="md-nav__link">
    <span class="md-ellipsis">
      DecompressPayload
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parsereportingurl" class="md-nav__link">
    <span class="md-ellipsis">
      ParseReportingUrl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#labelclickspikes" class="md-nav__link">
    <span class="md-ellipsis">
      LabelClickSpikes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregateimpressions" class="md-nav__link">
    <span class="md-ellipsis">
      AggregateImpressions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sendrequest" class="md-nav__link">
    <span class="md-ellipsis">
      SendRequest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bigquery-error-table" class="md-nav__link">
    <span class="md-ellipsis">
      BigQuery Error Table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#working-with-the-beam-job" class="md-nav__link">
    <span class="md-ellipsis">
      Working with the Beam Job
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-deployment" class="md-nav__link">
    <span class="md-ellipsis">
      Test Deployment
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decoder-job/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Decoder Job
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ingestion_testing_workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ingestion Testing Workflow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../republisher-job/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Republisher Job
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sink-job/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sink Job
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    ingestion-sink
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            ingestion-sink
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ingestion-sink/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#data-flows-for-contextual-services" class="md-nav__link">
    <span class="md-ellipsis">
      Data flows for Contextual Services
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#beam-pipeline-transforms" class="md-nav__link">
    <span class="md-ellipsis">
      Beam Pipeline Transforms
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Beam Pipeline Transforms">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pubsub-republished-topic" class="md-nav__link">
    <span class="md-ellipsis">
      Pub/Sub republished topic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filterbydoctype" class="md-nav__link">
    <span class="md-ellipsis">
      FilterByDoctype
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verifymetadata" class="md-nav__link">
    <span class="md-ellipsis">
      VerifyMetadata
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decompresspayload" class="md-nav__link">
    <span class="md-ellipsis">
      DecompressPayload
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parsereportingurl" class="md-nav__link">
    <span class="md-ellipsis">
      ParseReportingUrl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#labelclickspikes" class="md-nav__link">
    <span class="md-ellipsis">
      LabelClickSpikes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregateimpressions" class="md-nav__link">
    <span class="md-ellipsis">
      AggregateImpressions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sendrequest" class="md-nav__link">
    <span class="md-ellipsis">
      SendRequest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bigquery-error-table" class="md-nav__link">
    <span class="md-ellipsis">
      BigQuery Error Table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#working-with-the-beam-job" class="md-nav__link">
    <span class="md-ellipsis">
      Working with the Beam Job
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-deployment" class="md-nav__link">
    <span class="md-ellipsis">
      Test Deployment
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="contextual-services-reporter-job">Contextual Services Reporter Job</h1>
<p>The contextual services reporter forwards contextual-services click and impression events
to an external partner, with a particular eye towards minimizing the scope of contextual metadata
that is shared. For more context, see the
<a href="https://blog.mozilla.org/data/2021/09/15/data-and-firefox-suggest/">Data and Firefox Suggest blog post</a>.</p>
<p>The code is defined in the <a href="https://github.com/mozilla/gcp-ingestion/blob/main/ingestion-beam/src/main/java/com/mozilla/telemetry/ContextualServicesReporter.java"><code>com.mozilla.telemetry.ContextualServicesReporter</code></a> class.</p>
<p>The input of this job is all <code>contextual-services</code> namespace messages for desktop Firefox, which includes <code>topsites-impression</code>, <code>topsites-click</code>, <code>quicksuggest-impression</code>, and <code>quicksuggest-click</code>. It also includes <code>topsites-impression</code> pings from various mobile applications.</p>
<h2 id="data-flows-for-contextual-services">Data flows for Contextual Services</h2>
<p>Note that in addition to this near real-time Dataflow job, we have several batch workflows
for preparing Contextual Services data for both internal analytic use and for sending to
external partners.</p>
<p>Search terms handling starts with <a href="https://github.com/mozilla-services/cloudops-infra/blob/master/projects/merino/tf/modules/log-routing/main.tf">log routing configuration in <code>cloudops-infra</code></a> (Mozilla internal)
and then proceeds with a series of nightly scheduled queries defined under <a href="https://github.com/mozilla/bigquery-etl/tree/main/sql/moz-fx-data-shared-prod/search_terms_derived"><code>search_terms_derived</code></a> in <code>bigquery-etl</code>.
Additional aggregations for clicks and impressions are defined under <a href="https://github.com/mozilla/bigquery-etl/tree/main/sql/moz-fx-data-shared-prod/contextual_services_derived"><code>contextual_services_derived</code></a> in <code>bigquery-etl</code>.</p>
<p>Some daily aggregate data is shared with an external partner via the <a href="https://github.com/mozilla/telemetry-airflow/blob/main/dags/adm_export.py"><code>adm_export</code></a> DAG defined in <code>telemetry-airflow</code>.</p>
<h2 id="beam-pipeline-transforms">Beam Pipeline Transforms</h2>
<p>The following diagram shows the steps in the Beam pipeline. This is up to date as of 2021-08-23.</p>
<p><img alt="diagrams/ctxt-sender.mmd" src="../../diagrams/ctxt-sender.svg" />
<strong>Figure</strong>: <em>An overview of the execution graph for the <code>ContextualServicesReporter</code>.</em></p>
<h3 id="pubsub-republished-topic">Pub/Sub republished topic</h3>
<p>The input to this job is the subset of decoded messages in the <code>contextual-services</code> namespace as well as <code>topsites-impression</code> pings from various namespaces associated with mobile applications sending telemetry via Glean.</p>
<h3 id="filterbydoctype"><code>FilterByDoctype</code></h3>
<p>This step filters out document types based on the <code>document_type</code> attribute using the <code>--allowedDocTypes</code> pipeline option. For example, this can be used to allow the job to process only sponsored tiles or only Suggest events, or only clicks or only impressions.</p>
<h3 id="verifymetadata"><code>VerifyMetadata</code></h3>
<p>Message contents are validated in this step using a few simple heuristics such as user agent and user agent version. Messages that fail this check are rejected and sent to the error table.</p>
<h3 id="decompresspayload"><code>DecompressPayload</code></h3>
<p>This step attempts to decompress a gzip-compressed payload. This transform is shared with other Beam pipelines such as the decoder.</p>
<h3 id="parsereportingurl"><code>ParseReportingUrl</code></h3>
<p>This is where the URLs used for reporting events are built. The <code>reporting_url</code> value from the message payload is used as the base URL, then additional query parameters are added based on the message metadata such as the client’s country, region, and OS. The updated <code>reporting_url</code> value is put in the message payload and attributes.</p>
<h3 id="labelclickspikes"><code>LabelClickSpikes</code></h3>
<p>This step counts the number of click events per client (using the <code>context_id</code> attribute) in a time interval. This transform uses Beam’s state and timers; a state and a timer is maintained for every client. The state is a list of recent timestamps of clicks from the current client and the timer will clear the state if there are no recent clicks from the client. If the number of elements in the list exceeds the set threshold, any additional clicks will be marked with a <code>click-status</code>. Because a state needs to be maintained per client, the memory required for this step increases with the number of unique clients.</p>
<h3 id="aggregateimpressions"><code>AggregateImpressions</code></h3>
<p>This step groups impressions together in a timed window based on the reporting URLs. The purpose of this step is to reduce the number of HTTP requests made to external endpoints. One URL is output for each unique reporting URL in the timed window by counting the number of occurrences of each URL. The output URL is the original reporting URL with the additional query parameters <code>impressions</code>, <code>begin-timestamp</code>, and <code>end-timestamp</code>.</p>
<p>A Beam <code>IntervalWindow</code> is used to group by impressions together based on the processing time - the time at which the message enters this transform. The output is generated at the end of the window which means that there is an increased delay between when the impression enters the pipeline and when the corresponding reporting URL is requested. This transform needs to keep track of a window for every unique reporting URL it receives which means memory required increases with the number of unique URLs.</p>
<h3 id="sendrequest"><code>SendRequest</code></h3>
<p>This step sends a HTTP GET request to the URL specified by the <code>reporting_url</code> attribute in the message. To keep track of requests sent by the job for debugging purposes, successful requests will throw a <code>RequestContentException</code> which will add them to the BigQuery error table (see below).</p>
<h3 id="bigquery-error-table">BigQuery Error Table</h3>
<p>The job is configured at certain steps to catch runtime exceptions and write the message contents to BigQuery. The configured table is <code>moz-fx-data-shared-prod.payload_bytes_error.contextual_services</code>. This can be used for debugging or to backfill messages that initially failed to process.</p>
<h3 id="working-with-the-beam-job">Working with the Beam Job</h3>
<p>Options specific to this job are found in https://github.com/mozilla/gcp-ingestion/blob/main/ingestion-beam/src/main/java/com/mozilla/telemetry/contextualservices/ContextualServicesReporterOptions.java</p>
<h3 id="test-deployment">Test Deployment</h3>
<p>This job can be deployed in a sandbox project for testing. The <code>contextual-services-dev</code> project is currently used for this purpose.</p>
<p>There are a few required components to get a job running:</p>
<ul>
<li>A PubSub subscription on the republished <code>contextual-services</code> topic</li>
<li>A BigQuery table with the <code>payload_bytes_error</code> schema used for error output</li>
<li>A URL allowed list stored in GCS</li>
<li>The Beam pipeline running on Dataflow, reading from the PubSub subscription, and writing to the BigQuery table</li>
</ul>
<p>Example script to start the Dataflow job from the ingestion-beam directory:</p>
<pre><code>#!/bin/bash

set -ux

PROJECT=&quot;contextual-services-dev&quot;
JOB_NAME=&quot;contextual-services&quot;

mvn compile exec:java -Dexec.mainClass=com.mozilla.telemetry.ContextualServicesReporter -Dexec.args=&quot;\
   --runner=Dataflow \
   --jobName=$JOB_NAME \
   --project=$PROJECT  \
   --inputType=pubsub \
   --input='projects/contextual-services-dev/subscriptions/ctxsvc-input' \
   --outputTableRowFormat=payload \
   --errorBqWriteMethod=streaming \
   --errorOutputType=bigquery \
   --errorOutput=$PROJECT:contextual_services.reporting_errors \
   --region=us-central1 \
   --usePublicIps=true \
   --gcsUploadBufferSizeBytes=16777216 \
   --urlAllowList=gs://contextual-services-data-dev/urlAllowlist.csv \
   --allowedDocTypes=topsites-impression,topsites-click, \
   --reportingEnabled=false \
   --aggregationWindowDuration=10m \
   --clickSpikeWindowDuration=3m \
   --clickSpikeThreshold=10 \
   --logReportingUrls=true \
   --maxNumWorkers=2 \
   --numWorkers=1 \
   --autoscalingAlgorithm=THROUGHPUT_BASED \
&quot;
</code></pre>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.expand"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>