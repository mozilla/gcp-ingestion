
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Mozilla Telemetry ingestion on Google Cloud Platform">
      
      
        <meta name="author" content="Mozilla Data Platform Team">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.3.4">
    
    
      
        <title>Sink Job - GCP Ingestion</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.4a0965b7.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#009485">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="teal" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#sink-job" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="GCP Ingestion" class="md-header__button md-logo" aria-label="GCP Ingestion" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            GCP Ingestion
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Sink Job
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/mozilla/gcp-ingestion/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../architecture/overview/" class="md-tabs__link">
        Architecture
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../ingestion-edge/" class="md-tabs__link">
        ingestion-edge
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../" class="md-tabs__link md-tabs__link--active">
        ingestion-beam
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../ingestion-sink/" class="md-tabs__link">
        ingestion-sink
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="GCP Ingestion" class="md-nav__button md-logo" aria-label="GCP Ingestion" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    GCP Ingestion
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/mozilla/gcp-ingestion/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Architecture
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Architecture" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Architecture
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2_2">
          Architecture
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Architecture" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Architecture
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/bigquery_sink_specification/" class="md-nav__link">
        Live Sink Service Specification
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/decoder_service_specification/" class="md-nav__link">
        Decoder Service Specification
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/differences_from_aws/" class="md-nav__link">
        Differences from AWS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/edge_migration_plan/" class="md-nav__link">
        Plans for migrating edge traffic to GCP Ingestion
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/edge_service_specification/" class="md-nav__link">
        Edge Service Specification
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/landfill_service_specification/" class="md-nav__link">
        Raw Sink Service Specification
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/pain_points/" class="md-nav__link">
        Pain points
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/reliability/" class="md-nav__link">
        Reliability
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/test_requirements/" class="md-nav__link">
        Test Requirements
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          ingestion-edge
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="ingestion-edge" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          ingestion-edge
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ingestion-edge/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          ingestion-beam
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="ingestion-beam" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          ingestion-beam
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Ingestion beam
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Ingestion beam" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Ingestion beam
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../contextual-services-job/" class="md-nav__link">
        Contextual Services Reporter Job
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../decoder-job/" class="md-nav__link">
        Decoder Job
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ingestion_testing_workflow/" class="md-nav__link">
        Ingestion Testing Workflow
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../rally-job/" class="md-nav__link">
        Rally Decoder Job
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../republisher-job/" class="md-nav__link">
        Republisher Job
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Sink Job
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Sink Job
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#deprecated" class="md-nav__link">
    Deprecated
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supported-input-and-outputs" class="md-nav__link">
    Supported Input and Outputs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#encoding" class="md-nav__link">
    Encoding
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#output-path-specification" class="md-nav__link">
    Output Path Specification
  </a>
  
    <nav class="md-nav" aria-label="Output Path Specification">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bigquery" class="md-nav__link">
    BigQuery
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocol" class="md-nav__link">
    Protocol
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attribute-placeholders" class="md-nav__link">
    Attribute placeholders
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file-prefix" class="md-nav__link">
    File prefix
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#executing" class="md-nav__link">
    Executing
  </a>
  
    <nav class="md-nav" aria-label="Executing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#locally" class="md-nav__link">
    Locally
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#on-dataflow" class="md-nav__link">
    On Dataflow
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#on-dataflow-with-flex-templates" class="md-nav__link">
    On Dataflow with Flex Templates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#in-streaming-mode" class="md-nav__link">
    In streaming mode
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          ingestion-sink
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="ingestion-sink" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          ingestion-sink
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ingestion-sink/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#deprecated" class="md-nav__link">
    Deprecated
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supported-input-and-outputs" class="md-nav__link">
    Supported Input and Outputs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#encoding" class="md-nav__link">
    Encoding
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#output-path-specification" class="md-nav__link">
    Output Path Specification
  </a>
  
    <nav class="md-nav" aria-label="Output Path Specification">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bigquery" class="md-nav__link">
    BigQuery
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocol" class="md-nav__link">
    Protocol
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attribute-placeholders" class="md-nav__link">
    Attribute placeholders
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file-prefix" class="md-nav__link">
    File prefix
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#executing" class="md-nav__link">
    Executing
  </a>
  
    <nav class="md-nav" aria-label="Executing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#locally" class="md-nav__link">
    Locally
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#on-dataflow" class="md-nav__link">
    On Dataflow
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#on-dataflow-with-flex-templates" class="md-nav__link">
    On Dataflow with Flex Templates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#in-streaming-mode" class="md-nav__link">
    In streaming mode
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/mozilla/gcp-ingestion/edit/main/docs/ingestion-beam/sink-job.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="sink-job">Sink Job</h1>
<p>A job for delivering messages between Google Cloud services. Defined in the <code>com.mozilla.telemetry.Sink</code> class (<a href="https://github.com/mozilla/gcp-ingestion/blob/main/ingestion-beam/src/main/java/com/mozilla/telemetry/Sink.java">source</a>).</p>
<h2 id="deprecated">Deprecated</h2>
<p>This job has been replaced by <a href="../ingestion-sink">ingestion-sink</a> for loading messages from Google Cloud PubSub into BigQuery.</p>
<h2 id="supported-input-and-outputs">Supported Input and Outputs</h2>
<p>Supported inputs:</p>
<ul>
<li>Google Cloud PubSub</li>
<li>Google Cloud Storage</li>
</ul>
<p>Supported outputs:</p>
<ul>
<li>Google Cloud PubSub</li>
<li>Google Cloud Storage</li>
<li>Google Cloud BigQuery</li>
<li>stdout</li>
<li>stderr</li>
</ul>
<p>Supported error outputs, must include attributes and must not validate messages:</p>
<ul>
<li>Google Cloud PubSub</li>
<li>Google Cloud Storage with JSON encoding</li>
<li>stdout with JSON encoding</li>
<li>stderr with JSON encoding</li>
</ul>
<h2 id="encoding">Encoding</h2>
<p>Internally messages are stored and transported as
<a href="https://beam.apache.org/documentation/sdks/javadoc/2.6.0/org/apache/beam/sdk/io/gcp/pubsub/PubsubMessage.html">PubsubMessage</a>.</p>
<p>Supported file formats for Cloud Storage are <code>json</code> or <code>text</code>. The <code>json</code> file
format stores newline delimited JSON, encoding the field <code>payload</code> as a base64
string, and <code>attributeMap</code> as an optional object with string keys and values.
The <code>text</code> file format stores newline delimited strings, encoding the field
<code>payload</code> as <code>UTF-8</code>.</p>
<p>We'll construct example inputs based on the following two values and their base64 encodings:</p>
<pre><code>$ echo -en &quot;test&quot; | base64
dGVzdA==

$ echo -en &quot;test\n&quot; | base64
dGVzdAo=
</code></pre>
<p>Example <code>json</code> file:</p>
<pre><code>{"payload":"dGVzdA==","attributeMap":{"meta":"data"}}
{"payload":"dGVzdAo=","attributeMap":null}
{"payload":"dGVzdA=="}
</code></pre>
<p>The above file when stored in the <code>text</code> format:</p>
<pre><code>test
test

test
</code></pre>
<p>Note that the newline embedded at the end of the second JSON message results in
two text messages, one of which is blank.</p>
<h2 id="output-path-specification">Output Path Specification</h2>
<p>Depending on the specified output type, the <code>--output</code> path that you provide controls
several aspects of the behavior.</p>
<h3 id="bigquery">BigQuery</h3>
<p>When <code>--outputType=bigquery</code>, <code>--output</code> is a <code>tableSpec</code> of form <code>dataset.tablename</code>
or the more verbose <code>projectId:dataset.tablename</code>. The values can contain
attribute placeholders of form <code>${attribute_name}</code>. To set dataset to the
document namespace and table name to the document type, specify:</p>
<pre><code>--output='${document_namespace}.${document_type}'
</code></pre>
<p>All <code>-</code> characters in the attributes will be converted to <code>_</code> per BigQuery
naming restrictions. Additionally, document namespace and type values will
be processed to ensure they are in snake case format (<code>untrustedModules</code>
becomes <code>untrusted_modules</code>).</p>
<p>Defaults for the placeholders using <code>${attribute_name:-default_value}</code>
are supported, but likely don't make much sense since it's unlikely that
there is a default table whose schema is compatible with all potential
payloads.
Instead, records missing an attribute required by a placeholder
will be redirected to error output if no default is provided.</p>
<h3 id="protocol">Protocol</h3>
<p>When <code>--outputType=file</code>, <code>--output</code> may be prefixed by a protocol specifier
to determine the
target data store. Without a protocol prefix, the output path is assumed
to be a relative or absolute path on the filesystem. To write to Google
Cloud Storage, use a <code>gs://</code> path like:</p>
<pre><code>--output=gs://mybucket/somdir/myfileprefix
</code></pre>
<h3 id="attribute-placeholders">Attribute placeholders</h3>
<p>We support <code>FileIO</code>'s "Dynamic destinations" feature (<code>FileIO.writeDynamic</code>) where
it's possible to route individual messages to different output locations based
on properties of the message.
In our case, we allow routing messages based on the <code>PubsubMessage</code> attribute map.
Routing is accomplished by adding placeholders of form <code>${attribute_name:-default_value}</code>
to the path.</p>
<p>For example, to route based on a <code>document_type</code> attribute, your path might look like:</p>
<pre><code>--output=gs://mybucket/mydocs/${document_type:-UNSPECIFIED}/myfileprefix
</code></pre>
<p>Messages with <code>document_type</code> of "main" would be grouped together and end up in
the following directory:</p>
<pre><code>gs://mybucket/mydocs/main/
</code></pre>
<p>Messages with <code>document_type</code> set to <code>null</code> or missing that attribute completely
would be grouped together and end up in directory:</p>
<pre><code>gs://mybucket/mydocs/UNSPECIFIED/
</code></pre>
<p>Note that placeholders <em>must</em> specify a default value so that a poorly formatted
message doesn't cause a pipeline exception. A placeholder without a default will
result in an <code>IllegalArgumentException</code> on pipeline startup.</p>
<p>File-based outputs support the additional <em>derived</em> attributes
<code>"submission_date"</code> and <code>"submission_hour"</code> which will be parsed from the value
of the <code>submission_timestamp</code> attribute if it exists.
These can be useful for making sure your output specification buckets messages
into hourly directories.</p>
<p>The templating and default syntax used here is based on the
<a href="https://commons.apache.org/proper/commons-text/javadocs/api-release/org/apache/commons/text/StringSubstitutor.html">Apache commons-text <code>StringSubstitutor</code></a>,
which in turn bases its syntax on common practice in bash and other Unix/Linux shells.
Beware the need for proper escaping on the command line (use <code>\$</code> in place of <code>$</code>),
as your shell may try to substitute in values
for your placeholders before they're passed to <code>Sink</code>.</p>
<p><a href="https://cloud.google.com/pubsub/docs/reference/rest/v1/PubsubMessage">Google's PubsubMessage format</a>
allows arbitrary strings for attribute names and values. We place the following restrictions
on attribute names and default values used in placeholders:</p>
<ul>
<li>attribute names may not contain the string <code>:-</code></li>
<li>attribute names may not contain curly braces (<code>{</code> or <code>}</code>)</li>
<li>default values may not contain curly braces (<code>{</code> or <code>}</code>)</li>
</ul>
<h3 id="file-prefix">File prefix</h3>
<p>Individual files are named by replacing <code>:</code> with <code>-</code> in the default format discussed in
the "File naming" section of Beam's
<a href="https://beam.apache.org/documentation/sdks/javadoc/2.6.0/org/apache/beam/sdk/io/FileIO.html"><code>FileIO</code> Javadoc</a>:</p>
<pre><code>$prefix-$start-$end-$pane-$shard-of-$numShards$suffix$compressionSuffix
</code></pre>
<p>In our case, <code>$prefix</code> is determined from the last <code>/</code>-delimited piece of the <code>--output</code>
path. If you specify a path ending in <code>/</code>, you'll end up with an empty prefix
and your file names will begin with <code>-</code>. This is probably not what you want,
so it's recommended to end your output path with a non-empty file prefix. We replace <code>:</code>
with <code>-</code> because <a href="https://stackoverflow.com/q/48909921">Hadoop can't handle <code>:</code> in file names</a>.</p>
<p>For example, given:</p>
<pre><code>--output=/tmp/output/out
</code></pre>
<p>An output file might be:</p>
<pre><code>/tmp/output/out--290308-12-21T20-00-00.000Z--290308-12-21T20-10-00.000Z-00000-of-00001.ndjson
</code></pre>
<h2 id="executing">Executing</h2>
<p>Note: <code>-Dexec.args</code> does not handle newlines gracefully, but bash will remove
<code>\</code> escaped newlines in <code>"</code>s.</p>
<h3 id="locally">Locally</h3>
<p>If you install Java and maven, you can invoke <code>mvn</code> in the following commands
instead of using <code>./bin/mvn</code>; be aware, though, that Java 11 is the target JVM
and some reflection warnings may be thrown on newer versions, though these are
generally harmless.</p>
<p>The provided <code>bin/mvn</code> script downloads and runs maven via docker so that less
setup is needed on the local machine. For prolonged development performance is
likely to be significantly better, especially in MacOS, if <code>mvn</code> is installed and
run natively without docker.</p>
<pre><code class="language-bash"># create a test input file
mkdir -p tmp/
echo '{&quot;payload&quot;:&quot;dGVzdA==&quot;,&quot;attributeMap&quot;:{&quot;host&quot;:&quot;test&quot;}}' &gt; tmp/input.json

# consume messages from the test file, decode and re-encode them, and write to a directory
./bin/mvn compile exec:java -Dexec.args=&quot;\
    --inputFileFormat=json \
    --inputType=file \
    --input=tmp/input.json \
    --outputFileFormat=json \
    --outputType=file \
    --output=tmp/output/out \
    --errorOutputType=file \
    --errorOutput=tmp/error \
&quot;

# check that the message was delivered
cat tmp/output/*

# write message payload straight to stdout
./bin/mvn compile exec:java -Dexec.args=&quot;\
    --inputFileFormat=json \
    --inputType=file \
    --input=tmp/input.json \
    --outputFileFormat=text \
    --outputType=stdout \
    --errorOutputType=stderr \
&quot;

# check the help page to see types of options
./bin/mvn compile exec:java -Dexec.args=--help

# check the SinkOptions help page for options specific to Sink
./bin/mvn compile exec:java -Dexec.args=--help=SinkOptions
</code></pre>
<h3 id="on-dataflow">On Dataflow</h3>
<pre><code class="language-bash"># Pick a bucket to store files in
BUCKET=&quot;gs://$(gcloud config get-value project)&quot;

# create a test input file
echo '{&quot;payload&quot;:&quot;dGVzdA==&quot;,&quot;attributeMap&quot;:{&quot;host&quot;:&quot;test&quot;}}' | gsutil cp - $BUCKET/input.json

# Set credentials; beam is not able to use gcloud credentials
export GOOGLE_APPLICATION_CREDENTIALS=&quot;path/to/your/creds.json&quot;

# consume messages from the test file, decode and re-encode them, and write to a bucket
./bin/mvn compile exec:java -Dexec.args=&quot;\
    --runner=Dataflow \
    --inputFileFormat=json \
    --inputType=file \
    --input=$BUCKET/input.json \
    --outputFileFormat=json \
    --outputType=file \
    --output=$BUCKET/output \
    --errorOutputType=file \
    --errorOutput=$BUCKET/error \
&quot;

# wait for the job to finish
gcloud dataflow jobs list

# check that the message was delivered
gsutil cat $BUCKET/output/*
</code></pre>
<h3 id="on-dataflow-with-flex-templates">On Dataflow with Flex Templates</h3>
<p>The <a href="https://cloud.google.com/dataflow/docs/concepts/dataflow-templates">Dataflow templates documentation</a> explains:</p>
<blockquote>
<p>Dataflow templates allow you to stage your pipelines on Google Cloud and <a href="https://cloud.google.com/dataflow/docs/templates/executing-templates">run
them</a> using the Google Cloud
Console, the <code>gcloud</code> command-line tool, or REST API calls. [...] Flex Templates package the
pipeline as a Docker image and stage these images on your project's Container Registry.</p>
</blockquote>
<pre><code class="language-bash"># pick the project to store the docker image in
PROJECT=$(gcloud config get-value project)&quot;

# pick the region to run Dataflow jobs in
PROJECT=$(gcloud config get-value compute/region)&quot;

# pick the bucket to store files in
BUCKET=&quot;gs://$PROJECT&quot;

# configure gcloud credential helper for docker to push to GCR
gcloud auth configure-docker

# build the docker image for the Flex Template
export IMAGE=gcr.io/$PROJECT/ingestion-beam/sink:latest
docker-compose build --build-arg FLEX_TEMPLATE_JAVA_MAIN_CLASS=com.mozilla.telemetry.Sink
docker-compose push

# create the Flex Template
gcloud dataflow flex-template build \
    $BUCKET/sink/flex-templates/latest.json \
    --image $IMAGE \
    --sdk-language JAVA

# create a test input file
echo '{&quot;payload&quot;:&quot;dGVzdA==&quot;,&quot;attributeMap&quot;:{&quot;host&quot;:&quot;test&quot;}}' | gsutil cp - $BUCKET/input.json

# run the dataflow Flex Template with gcloud
JOBNAME=file-to-file1
REGION=$(gcloud config get-value compute/region 2&gt;&amp;1 | sed 's/(unset)/us-central1/')
gcloud dataflow flex-template run $JOBNAME \
    --template-file-gcs-location=$BUCKET/sink/flex-templates/latest.json \
    --region=$REGION \
    --parameters=inputType=file \
    --parameters=outputType=file \
    --parameters=errorOutputType=file \
    --parameters=inputFileFormat=json \
    --parameters=outputFileFormat=json \
    --parameters=input=$BUCKET/input.json \
    --parameters=output=$BUCKET/output/ \
    --parameters=errorOutput=$BUCKET/error/

# get the job id
JOB_ID=&quot;$(gcloud dataflow jobs list --region=$REGION --filter=name=$JOBNAME --format='value(JOB_ID)' --limit=1)&quot;

# wait for the job to finish
gcloud dataflow jobs show &quot;$JOB_ID&quot; --region=$REGION

# check that the message was delivered
gsutil cat $BUCKET/output/*
</code></pre>
<h3 id="in-streaming-mode">In streaming mode</h3>
<p>If <code>--inputType=pubsub</code>, Beam will execute in streaming mode, requiring some
extra configuration for file-based outputs. You will need to specify sharding like:</p>
<pre><code>    --outputNumShards=10 \
    --errorOutputNumShards=10 \
</code></pre>
<p>or for Flex Templates:</p>
<pre><code>    --parameters=outputNumShards=10 \
    --parameters=errorOutputNumShards=10 \
</code></pre>
<p>As discussed in the
<a href="https://beam.apache.org/releases/javadoc/2.8.0/org/apache/beam/sdk/io/FileIO.Write.html#withNumShards-int-">Beam documentation for <code>FileIO.Write#withNumShards</code></a>,
batch mode is most efficient when the runner is left to determine sharding,
so <code>numShards</code> options should normally be left to their default of <code>0</code>, but
streaming mode can't perform the same optimizations thus an exception will be thrown
during pipeline construction if sharding is not specified.
As codified in <a href="https://github.com/apache/beam/pull/1952">apache/beam/pull/1952</a>,
the Dataflow runner suggests a reasonable starting point <code>numShards</code> is <code>2 * maxWorkers</code>
or 10 if <code>--maxWorkers</code> is unspecified.</p>

              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../republisher-job/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Republisher Job" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Republisher Job
            </div>
          </div>
        </a>
      
      
        
        <a href="../../ingestion-sink/" class="md-footer__link md-footer__link--next" aria-label="Next: Overview" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Overview
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.expand"], "search": "../../assets/javascripts/workers/search.85cb4492.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.f758a944.min.js"></script>
      
    
  </body>
</html>