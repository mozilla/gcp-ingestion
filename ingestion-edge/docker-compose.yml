version: '3'

# configure ingestion-edge for ci
services:
  web:
    build: .
    image: &image "${DOCKERHUB_REPO-ingestion-edge}:${CIRCLE_TAG-latest}"
    environment: &web-env
      PUBSUB_EMULATOR_HOST: pubsub:8085
      ROUTE_TABLE: >-
        [
          [
            "/stub/<suffix:path>",
            "projects/test/topics/stub_installer",
            ["GET"]
          ],
          [
            "/submit/telemetry/<suffix:path>",
            "projects/test/topics/telemetry"
          ],
          [
            "/submit/sslreports",
            "projects/test/topics/tls_error_reports",
            ["post", "put"]
          ],
          [
            "/submit/<suffix:path>",
            "projects/test/topics/ingestion",
            ["PoSt", "pUt"]
          ],
          [
            "/submit",
            "projects/test/topics/ingestion"
          ]
        ]
  pubsub:
    build: .
    image: *image
    command: gcloud beta emulators pubsub start
    environment:
      PUBSUB_EMULATOR_HOST: 0.0.0.0:8085
  test:
    build: .
    image: *image
    command:
    - bin/pytest-all
    environment:
      <<: *web-env
      REQUIRE_CODE_COVERAGE: 'false'
